<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>设置 - 智能对话系统</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome -->
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <!-- 配置 Tailwind CSS -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5",
              secondary: "#F3F4F6",
              neutral: "#1F2937",
              "neutral-light": "#F9FAFB",
              "border-color": "#E5E7EB",
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
        .card-rounded {
          border-radius: 0.75rem;
        }
        .form-input-focus {
          @apply focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary;
        }
        .btn-primary {
          @apply bg-primary text-white py-2 px-4 rounded-lg font-medium hover:bg-primary/90 transition-colors duration-200;
        }
        .btn-secondary {
          @apply bg-white border border-border-color py-2 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors duration-200;
        }
        .setting-item {
          @apply flex items-center justify-between py-3 border-b border-border-color;
        }
        .setting-item:last-child {
          @apply border-b-0;
        }
        /* 深色模式样式 */
        .dark {
          background-color: #1a1a1a;
          color: #f0f0f0;
        }
        .dark .bg-white {
          background-color: #2d2d2d !important;
        }
        .dark .text-neutral {
          color: #f0f0f0 !important;
        }
        .dark .text-gray-500 {
          color: #a0a0a0 !important;
        }
        .dark .text-gray-600 {
          color: #b0b0b0 !important;
        }
        .dark .text-gray-700 {
          color: #c0c0c0 !important;
        }
        .dark .border-border-color {
          border-color: #404040 !important;
        }
        .dark .bg-gray-50 {
          background-color: #1a1a1a !important;
        }
        .dark .form-input-focus {
          background-color: #2d2d2d !important;
          color: #f0f0f0 !important;
          border-color: #404040 !important;
        }
        .dark .form-input-focus:focus {
          background-color: #333333 !important;
        }
        .dark #password-modal-content {
          background-color: #2d2d2d !important;
        }
        .dark #delete-modal-content {
          background-color: #2d2d2d !important;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans text-neutral min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm border-b border-border-color">
      <div
        class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between"
      >
        <div class="flex items-center space-x-4">
          <a
            href="index.html"
            class="text-gray-500 hover:text-primary transition-colors duration-200"
          >
            <i class="fa fa-arrow-left text-lg"></i>
          </a>
          <h1 class="text-xl font-bold text-neutral">设置</h1>
        </div>
        <div id="user-info" class="flex items-center space-x-2">
          <div
            class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center"
          >
            <i class="fa fa-user text-primary text-sm"></i>
          </div>
          <div>
            <div id="username-display" class="text-sm font-medium text-neutral">
              加载中...
            </div>
            <div id="nickname-display" class="text-xs text-gray-500">
              加载中...
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- 设置内容区域 -->
    <main class="max-w-4xl mx-auto px-4 py-6">
      <!-- 用户信息卡片 -->
      <section
        class="bg-white shadow-sm card-rounded border border-border-color mb-6 p-4"
      >
        <h2 class="text-lg font-semibold text-neutral mb-4 flex items-center">
          <i class="fa fa-user-circle mr-2 text-primary"></i>
          用户信息
        </h2>
        <div class="space-y-3">
          <div class="setting-item">
            <span class="text-gray-700">用户名</span>
            <span id="username" class="text-neutral font-medium"
              >加载中...</span
            >
          </div>
          <div class="setting-item">
            <span class="text-gray-700">昵称</span>
            <span id="nickname" class="text-neutral font-medium"
              >加载中...</span
            >
          </div>
          <div class="setting-item">
            <span class="text-gray-700">注册时间</span>
            <span id="created-at" class="text-neutral font-medium"
              >加载中...</span
            >
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-border-color">
          <a
            href="user-center.html"
            class="btn-primary text-sm inline-flex items-center"
          >
            <i class="fa fa-edit mr-2"></i>
            编辑个人信息
          </a>
        </div>
      </section>

      <!-- 外观设置卡片 -->
      <section
        class="bg-white shadow-sm card-rounded border border-border-color mb-6 p-4"
      >
        <h2 class="text-lg font-semibold text-neutral mb-4 flex items-center">
          <i class="fa fa-palette mr-2 text-primary"></i>
          外观设置
        </h2>
        <div class="space-y-3">
          <div class="setting-item">
            <div>
              <span class="text-gray-700">主题模式</span>
              <p class="text-xs text-gray-500">选择您喜欢的界面主题</p>
            </div>
            <div class="flex items-center space-x-2">
              <button
                id="light-theme"
                class="px-3 py-1 rounded-lg text-sm border border-border-color bg-white text-neutral"
              >
                <i class="fa fa-sun mr-1"></i>
                浅色
              </button>
              <button
                id="dark-theme"
                class="px-3 py-1 rounded-lg text-sm border border-border-color bg-white text-neutral"
              >
                <i class="fa fa-moon mr-1"></i>
                深色
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- 安全设置卡片 -->
      <section
        class="bg-white shadow-sm card-rounded border border-border-color mb-6 p-4"
      >
        <h2 class="text-lg font-semibold text-neutral mb-4 flex items-center">
          <i class="fa fa-shield-alt mr-2 text-primary"></i>
          安全设置
        </h2>
        <div class="space-y-3">
          <div class="setting-item">
            <div>
              <span class="text-gray-700">修改密码</span>
              <p class="text-xs text-gray-500">更改您的账户密码</p>
            </div>
            <button id="change-password-btn" class="btn-secondary text-sm">
              <i class="fa fa-key mr-1"></i>
              修改
            </button>
          </div>
          <div class="setting-item">
            <div>
              <span class="text-red-600">删除账户</span>
              <p class="text-xs text-gray-500">永久删除您的账户和所有数据</p>
            </div>
            <button
              id="delete-account-btn"
              class="bg-white border border-red-200 text-red-600 py-2 px-4 rounded-lg font-medium hover:bg-red-50 transition-colors duration-200 text-sm"
            >
              <i class="fa fa-trash mr-1"></i>
              删除
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- 修改密码模态框 -->
    <div
      id="password-modal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
        id="password-modal-content"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-neutral">修改密码</h3>
          <button
            id="close-password-modal"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fa fa-times"></i>
          </button>
        </div>

        <form id="password-form">
          <div class="mb-4">
            <label
              for="current-password"
              class="block text-sm font-medium text-gray-700 mb-1"
              >当前密码</label
            >
            <input
              type="password"
              id="current-password"
              class="w-full px-4 py-2 border border-border-color rounded-lg form-input-focus"
              placeholder="请输入当前密码"
              required
            />
          </div>

          <div class="mb-4">
            <label
              for="new-password"
              class="block text-sm font-medium text-gray-700 mb-1"
              >新密码</label
            >
            <input
              type="password"
              id="new-password"
              class="w-full px-4 py-2 border border-border-color rounded-lg form-input-focus"
              placeholder="请输入新密码"
              required
            />
            <p class="text-xs text-gray-500 mt-1">密码长度至少8位</p>
          </div>

          <div class="mb-6">
            <label
              for="confirm-password"
              class="block text-sm font-medium text-gray-700 mb-1"
              >确认新密码</label
            >
            <input
              type="password"
              id="confirm-password"
              class="w-full px-4 py-2 border border-border-color rounded-lg form-input-focus"
              placeholder="请再次输入新密码"
              required
            />
          </div>

          <div class="flex space-x-3">
            <button
              type="button"
              id="cancel-password"
              class="flex-1 btn-secondary"
            >
              取消
            </button>
            <button type="submit" class="flex-1 btn-primary">确认修改</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 确认删除模态框 -->
    <div
      id="delete-modal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
        id="delete-modal-content"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-neutral">确认删除账户</h3>
          <button
            id="close-delete-modal"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fa fa-times"></i>
          </button>
        </div>

        <p class="text-gray-600 mb-4">
          您确定要删除您的账户吗？此操作无法撤销，所有数据将被永久删除。
        </p>

        <div class="flex space-x-3">
          <button id="cancel-delete" class="flex-1 btn-secondary">取消</button>
          <button
            id="confirm-delete"
            class="flex-1 bg-red-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors duration-200"
          >
            确认删除
          </button>
        </div>
      </div>
    </div>

    <!-- 成功提示 -->
    <div
      id="success-toast"
      class="fixed bottom-4 right-4 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg shadow-lg flex items-center transform translate-y-10 opacity-0 transition-all duration-300 z-50"
    >
      <i class="fa fa-check-circle mr-2 text-green-500"></i>
      <span id="toast-message">操作成功！</span>
    </div>

    <!-- 错误提示 -->
    <div
      id="error-toast"
      class="fixed bottom-4 right-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg shadow-lg flex items-center transform translate-y-10 opacity-0 transition-all duration-300 z-50"
    >
      <i class="fa fa-times-circle mr-2 text-red-500"></i>
      <span id="error-message">操作失败！</span>
    </div>

    <!-- JavaScript 逻辑 -->
    <script>
      // 全局变量
      let apiBaseUrl = "https://ragchat.top:3000"; // 后端服务器地址

      document.addEventListener("DOMContentLoaded", function () {
        // 检查登录状态
        if (!localStorage.getItem("userLoggedIn")) {
          window.location.href = "login.html";
          return;
        }

        // 获取DOM元素
        const usernameDisplay = document.getElementById("username-display");
        const nicknameDisplay = document.getElementById("nickname-display");
        const username = document.getElementById("username");
        const nickname = document.getElementById("nickname");
        const createdAt = document.getElementById("created-at");
        const lightThemeBtn = document.getElementById("light-theme");
        const darkThemeBtn = document.getElementById("dark-theme");
        const changePasswordBtn = document.getElementById(
          "change-password-btn",
        );
        const deleteAccountBtn = document.getElementById("delete-account-btn");

        // 密码模态框元素
        const passwordModal = document.getElementById("password-modal");
        const passwordModalContent = document.getElementById(
          "password-modal-content",
        );
        const closePasswordModal = document.getElementById(
          "close-password-modal",
        );
        const cancelPassword = document.getElementById("cancel-password");
        const passwordForm = document.getElementById("password-form");

        // 删除模态框元素
        const deleteModal = document.getElementById("delete-modal");
        const deleteModalContent = document.getElementById(
          "delete-modal-content",
        );
        const closeDeleteModal = document.getElementById("close-delete-modal");
        const cancelDelete = document.getElementById("cancel-delete");
        const confirmDelete = document.getElementById("confirm-delete");

        // 提示元素
        const successToast = document.getElementById("success-toast");
        const toastMessage = document.getElementById("toast-message");
        const errorToast = document.getElementById("error-toast");
        const errorMessage = document.getElementById("error-message");

        // 加载用户信息和设置
        loadUserInfo();
        loadSettings();

        // 主题切换事件
        lightThemeBtn.addEventListener("click", function () {
          setTheme("light");
        });

        darkThemeBtn.addEventListener("click", function () {
          setTheme("dark");
        });

        // 修改密码按钮
        changePasswordBtn.addEventListener("click", function () {
          openPasswordModal();
        });

        // 删除账户按钮
        deleteAccountBtn.addEventListener("click", function () {
          openDeleteModal();
        });

        // 密码模态框事件
        closePasswordModal.addEventListener("click", closePasswordModalFunc);
        cancelPassword.addEventListener("click", closePasswordModalFunc);

        // 密码表单提交
        passwordForm.addEventListener("submit", function (e) {
          e.preventDefault();

          const currentPassword =
            document.getElementById("current-password").value;
          const newPassword = document.getElementById("new-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          // 简单的表单验证
          if (!currentPassword || !newPassword || !confirmPassword) {
            showError("请填写所有字段");
            return;
          }

          if (newPassword.length < 8) {
            showError("新密码长度至少8位");
            return;
          }

          if (newPassword !== confirmPassword) {
            showError("两次输入的密码不一致");
            return;
          }

          // 调用API修改密码
          changePassword(currentPassword, newPassword);
        });

        // 删除模态框事件
        closeDeleteModal.addEventListener("click", closeDeleteModalFunc);
        cancelDelete.addEventListener("click", closeDeleteModalFunc);
        confirmDelete.addEventListener("click", confirmDeleteFunc);

        // 点击模态框外部关闭
        passwordModal.addEventListener("click", function (e) {
          if (e.target === passwordModal) {
            closePasswordModalFunc();
          }
        });

        deleteModal.addEventListener("click", function (e) {
          if (e.target === deleteModal) {
            closeDeleteModalFunc();
          }
        });

        // 按ESC键关闭模态框
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            if (!passwordModal.classList.contains("hidden")) {
              closePasswordModalFunc();
            } else if (!deleteModal.classList.contains("hidden")) {
              closeDeleteModalFunc();
            }
          }
        });

        // 加载用户信息
        async function loadUserInfo() {
          try {
            const token = localStorage.getItem("authToken");
            if (!token) {
              window.location.href = "login.html";
              return;
            }

            const response = await fetch(`${apiBaseUrl}/api/auth/verify`, {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (!response.ok) {
              throw new Error("获取用户信息失败");
            }

            const data = await response.json();
            const user = data.user;

            // 更新用户信息显示
            usernameDisplay.textContent = user.username;
            nicknameDisplay.textContent = user.nickname || user.username;
            username.textContent = user.username;
            nickname.textContent = user.nickname || user.username;

            // 格式化注册时间
            if (user.createdAt) {
              const date = new Date(user.createdAt);
              createdAt.textContent = date.toLocaleDateString("zh-CN");
            } else {
              createdAt.textContent = "未知";
            }
          } catch (error) {
            console.error("加载用户信息时出错:", error);
            showError("加载用户信息失败");
          }
        }

        // 加载设置
        function loadSettings() {
          // 加载主题设置
          const savedTheme = localStorage.getItem("theme") || "light";
          setTheme(savedTheme);
        }

        // 设置主题
        function setTheme(theme) {
          if (theme === "dark") {
            document.documentElement.classList.add("dark");
            document.body.classList.add("dark");
            darkThemeBtn.classList.add("bg-primary", "text-white");
            darkThemeBtn.classList.remove("bg-white", "text-neutral");
            lightThemeBtn.classList.remove("bg-primary", "text-white");
            lightThemeBtn.classList.add("bg-white", "text-neutral");
          } else {
            document.documentElement.classList.remove("dark");
            document.body.classList.remove("dark");
            lightThemeBtn.classList.add("bg-primary", "text-white");
            lightThemeBtn.classList.remove("bg-white", "text-neutral");
            darkThemeBtn.classList.remove("bg-primary", "text-white");
            darkThemeBtn.classList.add("bg-white", "text-neutral");
          }

          localStorage.setItem("theme", theme);
        }

        // 修改密码
        async function changePassword(oldPassword, newPassword) {
          try {
            const token = localStorage.getItem("authToken");
            if (!token) {
              showError("请先登录");
              return;
            }

            const response = await fetch(
              `${apiBaseUrl}/api/auth/change-password`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ oldPassword, newPassword }),
              },
            );

            const data = await response.json();

            if (data.success) {
              showToast("密码修改成功！");
              closePasswordModalFunc();
              passwordForm.reset();
            } else {
              showError(data.message || "密码修改失败");
            }
          } catch (error) {
            console.error("修改密码时出错:", error);
            showError("修改密码时出错，请稍后再试");
          }
        }

        // 打开密码模态框
        function openPasswordModal() {
          passwordModal.classList.remove("hidden");
          // 触发重排以允许动画生效
          void passwordModalContent.offsetWidth;
          passwordModalContent.classList.remove("scale-95", "opacity-0");
          passwordModalContent.classList.add("scale-100", "opacity-100");
        }

        // 关闭密码模态框
        function closePasswordModalFunc() {
          passwordModalContent.classList.remove("scale-100", "opacity-100");
          passwordModalContent.classList.add("scale-95", "opacity-0");
          setTimeout(() => {
            passwordModal.classList.add("hidden");
            passwordForm.reset();
          }, 300);
        }

        // 打开删除模态框
        function openDeleteModal() {
          deleteModal.classList.remove("hidden");
          // 触发重排以允许动画生效
          void deleteModalContent.offsetWidth;
          deleteModalContent.classList.remove("scale-95", "opacity-0");
          deleteModalContent.classList.add("scale-100", "opacity-100");
        }

        // 关闭删除模态框
        function closeDeleteModalFunc() {
          deleteModalContent.classList.remove("scale-100", "opacity-100");
          deleteModalContent.classList.add("scale-95", "opacity-0");
          setTimeout(() => {
            deleteModal.classList.add("hidden");
          }, 300);
        }

        // 确认删除账户
        async function confirmDeleteFunc() {
          try {
            const token = localStorage.getItem("authToken");
            if (!token) {
              showError("请先登录");
              return;
            }

            const response = await fetch(
              `${apiBaseUrl}/api/auth/delete-account`,
              {
                method: "DELETE",
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              },
            );

            if (!response.ok) {
              const data = await response.json();
              throw new Error(data.message || "删除账户失败");
            }

            // 清除本地存储的认证信息
            localStorage.removeItem("authToken");
            localStorage.removeItem("userLoggedIn");
            localStorage.removeItem("currentUser");
            localStorage.removeItem("userNickname");

            // 关闭模态框
            closeDeleteModalFunc();

            // 显示成功消息并跳转到注册页面
            showToast("账户已删除，即将跳转到注册页面...");
            setTimeout(() => {
              window.location.href = "register.html";
            }, 2000);
          } catch (error) {
            console.error("删除账户时出错:", error);
            showError(error.message || "删除账户时出错，请稍后再试");
          }
        }

        // 显示成功提示
        function showToast(message) {
          toastMessage.textContent = message;
          successToast.classList.remove("translate-y-10", "opacity-0");

          // 3秒后自动隐藏
          setTimeout(() => {
            successToast.classList.add("translate-y-10", "opacity-0");
          }, 3000);
        }

        // 显示错误提示
        function showError(message) {
          errorMessage.textContent = message;
          errorToast.classList.remove("translate-y-10", "opacity-0");

          // 3秒后自动隐藏
          setTimeout(() => {
            errorToast.classList.add("translate-y-10", "opacity-0");
          }, 3000);
        }
      });
    </script>
  </body>
</html>
