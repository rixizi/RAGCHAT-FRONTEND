<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>智能对话系统</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome -->
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <!-- 配置 Tailwind CSS -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5",
              secondary: "#F3F4F6",
              neutral: "#1F2937",
              "neutral-light": "#F9FAFB",
              "border-color": "#E5E7EB",
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
        .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
        .chat-container {
          height: calc(100vh - 4rem);
        }
        .message-bubble-ai {
          background-color: #eff6ff;
          border-radius: 1rem;
          border-bottom-left-radius: 0.25rem;
        }
        .message-bubble-user {
          background-color: #4f46e5;
          color: white;
          border-radius: 1rem;
          border-bottom-right-radius: 0.25rem;
        }
        /* 深色模式样式 */
        .dark {
          background-color: #1a1a1a;
          color: #f0f0f0;
        }
        .dark .bg-white {
          background-color: #2d2d2d !important;
        }
        .dark .bg-gray-50 {
          background-color: #1a1a1a !important;
        }
        .dark .text-neutral {
          color: #f0f0f0 !important;
        }
        .dark .text-gray-500 {
          color: #a0a0a0 !important;
        }
        .dark .text-gray-600 {
          color: #b0b0b0 !important;
        }
        .dark .text-gray-700 {
          color: #c0c0c0 !important;
        }
        .dark .text-gray-800 {
          color: #d0d0d0 !important;
        }
        .dark .text-gray-500 {
          color: #a0a0a0 !important;
        }
        .dark .text-gray-400 {
          color: #9ca3af !important;
        }
        .dark .bg-blue-50 .font-medium,
        .dark .bg-blue-50 .text-gray-500,
        .dark .bg-blue-50 .text-gray-400 {
          color: white !important;
        }
        .dark .border-border-color {
          border-color: #404040 !important;
        }
        .dark .hover\:bg-gray-100:hover {
          background-color: #333333 !important;
        }
        .dark .hover\:bg-gray-50:hover {
          background-color: #2a2a2a !important;
        }
        .dark .hover\:text-gray-700:hover {
          color: #d0d0d0 !important;
        }
        .dark .message-bubble-ai {
          background-color: #4f46e5;
          color: white;
        }
        .dark .message-bubble-ai p,
        .dark .message-bubble-ai .text-gray-800 {
          color: white !important;
        }
        .dark .bg-blue-50 {
          background-color: #374151 !important;
        }
        .dark .border-l-4.border-primary {
          border-color: #4f46e5 !important;
        }
        .dark textarea,
        .dark input {
          background-color: #333333 !important;
          color: #f0f0f0 !important;
          border-color: #404040 !important;
        }
        .dark textarea:focus,
        .dark input:focus {
          border-color: #4f46e5 !important;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans text-neutral">
    <!-- 主容器 -->
    <div class="flex h-screen overflow-hidden">
      <!-- 左侧边栏 - 历史记录 -->
      <div
        class="w-64 bg-white border-r border-border-color flex flex-col h-screen"
      >
        <!-- 顶部按钮 -->
        <div class="p-4 border-b border-border-color">
          <button
            id="new-conversation-btn"
            class="w-full bg-primary text-white py-2 px-4 rounded-lg font-medium hover:bg-primary/90 transition-colors duration-200"
          >
            <i class="fa fa-plus mr-2"></i>新建对话
          </button>
        </div>

        <!-- 历史记录列表 -->
        <div
          class="flex-1 overflow-y-auto scrollbar-hide"
          id="conversation-list"
        >
          <div class="p-2" id="conversation-container">
            <!-- 对话列表将通过JavaScript动态加载 -->
            <div class="text-center text-gray-500 py-8" id="no-conversations">
              <i class="fa fa-comments text-3xl mb-2"></i>
              <p>暂无对话历史</p>
              <p class="text-sm">点击"新建对话"开始聊天</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 中间区域 - 对话内容 -->
      <div class="flex-1 flex flex-col bg-gray-50">
        <!-- 顶部历史记录 -->
        <div
          class="p-4 border-b border-border-color bg-white flex items-center justify-between"
        >
          <div id="conversation-title" class="font-medium">新对话</div>
          <div class="flex items-center space-x-3">
            <button
              class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100"
            >
              <i class="fa fa-refresh"></i>
            </button>
            <button
              class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100"
            >
              <i class="fa fa-ellipsis-h"></i>
            </button>
          </div>
        </div>

        <!-- 服务状态提示 -->
        <div
          id="service-status"
          class="p-3 bg-amber-50 border-b border-amber-200 text-amber-800 text-sm hidden"
        >
          <i class="fa fa-info-circle mr-2"></i>
          <span>正在检查AI助手服务状态...</span>
        </div>

        <!-- 对话消息区域 -->
        <div class="flex-1 overflow-y-auto p-6 space-y-6" id="chat-messages">
          <!-- 欢迎消息 -->
          <div class="flex items-start space-x-4">
            <div
              class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex-shrink-0 flex items-center justify-center shadow-lg"
            >
              <i class="fa fa-smile-o text-white text-lg"></i>
            </div>
            <div class="message-bubble-ai p-4 max-w-[70%]">
              <p>欢迎使用植物营养土壤肥料灌溉科普系统！</p>
              <p class="mt-2">
                我是你的AI助手，专门解答关于植物营养、土壤、肥料和灌溉的各种问题。请输入你的问题，我会尽力为你提供帮助。
              </p>
            </div>
          </div>
        </div>

        <!-- 底部输入区域 -->
        <div class="p-4 border-t border-border-color bg-white">
          <div class="flex items-center space-x-3">
            <div class="flex-1 relative">
              <textarea
                id="message-input"
                placeholder="请输入你的问题"
                class="w-full p-3 border border-border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none transition-all duration-200"
                rows="1"
              ></textarea>
            </div>
            <button
              id="send-button"
              class="bg-primary text-white p-3 rounded-lg hover:bg-primary/90 transition-colors duration-200"
            >
              发送
            </button>
          </div>
          <div class="text-xs text-gray-500 mt-2">
            Shift + Enter 换行，Enter 发送
          </div>
        </div>
      </div>

      <!-- 右侧边栏 - 用户信息 -->
      <div class="w-56 bg-white border-l border-border-color hidden md:block">
        <div class="p-4 border-b border-border-color">
          <div class="flex items-center mb-4">
            <div
              class="w-10 h-10 bg-primary rounded-full flex items-center justify-center"
            >
              <i class="fa fa-user text-white"></i>
            </div>
            <div id="user-display-nickname" class="ml-3 text-sm font-bold">
              访客
            </div>
            <div
              id="user-info-toggle"
              class="text-gray-500 cursor-pointer hover:text-gray-700 ml-auto"
              onclick="toggleUserInfo()"
            >
              <i class="fa fa-angle-down"></i>
            </div>
          </div>

          <div id="user-info-details" class="space-y-2 hidden">
            <div id="user-display-username" class="text-xs text-gray-500">
              用户名
            </div>
          </div>
        </div>

        <div class="p-4">
          <div class="space-y-3">
            <a
              href="user-center.html"
              class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 transition-colors duration-200"
            >
              <i class="fa fa-user-circle text-gray-500"></i>
              <span class="text-sm">用户中心</span>
            </a>
            <a
              href="settings.html"
              class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 transition-colors duration-200"
            >
              <i class="fa fa-cog text-gray-500"></i>
              <span class="text-sm">设置</span>
            </a>
            <a
              href="help-center.html"
              class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 transition-colors duration-200"
            >
              <i class="fa fa-question-circle text-gray-500"></i>
              <span class="text-sm">帮助中心</span>
            </a>
            <button
              id="logout-button"
              class="flex items-center space-x-3 p-2 rounded-lg hover:bg-red-50 text-red-600 transition-colors duration-200 w-full justify-start text-sm"
            >
              <i class="fa fa-sign-out"></i>
              <span>退出登录</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript 逻辑 -->
    <script>
      // 全局变量
      let currentConversationId = null;
      let currentMessages = [];
      let currentUser = null;
      let apiBaseUrl = "http://8.141.14.50:3000"; // 后端服务器地址
      let apiKey = localStorage.getItem("apiKey") || "";
      let isAuthenticated = !!localStorage.getItem("token");
      let conversations = [];

      // 页面加载时初始化
      document.addEventListener("DOMContentLoaded", function () {
        // 初始化深色模式
        initDarkMode();

        // 页面加载完成后立即更新用户信息
        updateUserInfo();

        // 监听storage事件，当localStorage变化时更新用户信息
        window.addEventListener("storage", updateUserInfo);

        // 添加页面关闭前自动保存临时对话的功能
        window.addEventListener("beforeunload", handleBeforeUnload);

        // 添加页面可见性变化时自动保存临时对话的功能
        document.addEventListener("visibilitychange", handleVisibilityChange);

        // 添加浏览器标签页切换时自动保存临时对话的功能
        window.addEventListener("blur", handleWindowBlur);
        window.addEventListener("focus", handleWindowFocus);

        // 初始化聊天功能（包括加载对话列表）
        initializeChat();
      });

      // 初始化深色模式
      function initDarkMode() {
        // 从localStorage获取主题设置
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          document.body.classList.add("dark");
        }
      }

      // 处理页面关闭前的事件
      async function handleBeforeUnload(event) {
        // 不再自动保存临时对话到数据库，因为：
        // 1. 页面隐藏和窗口失去焦点时已经保存到localStorage
        // 2. 用户可以通过点击保存按钮或切换对话来主动保存
        // 3. 退出登录时已经处理了保存逻辑
        // 这样可以避免在导航到其他页面时意外保存临时对话

        // 只将临时对话保存到localStorage，确保不会丢失
        if (isTemporaryConversation && currentMessages.length > 0) {
          try {
            localStorage.setItem(
              "tempConversation",
              JSON.stringify({
                messages: currentMessages,
                timestamp: Date.now(),
              }),
            );
            localStorage.setItem("hasTempConversation", "true");
            console.log("页面关闭前临时对话已保存到localStorage");
          } catch (error) {
            console.error("页面关闭前保存临时对话到localStorage失败:", error);
          }
        }
      }

      // 处理页面可见性变化的事件
      async function handleVisibilityChange() {
        // 当页面变为不可见时（切换标签页或最小化窗口），如果有临时对话且有消息，则保存到localStorage
        if (
          document.visibilityState === "hidden" &&
          isTemporaryConversation &&
          currentMessages.length > 0
        ) {
          try {
            // 只保存临时对话到localStorage，不自动保存到数据库
            localStorage.setItem(
              "tempConversation",
              JSON.stringify({
                messages: currentMessages,
                timestamp: Date.now(),
              }),
            );
            localStorage.setItem("hasTempConversation", "true");
            console.log("临时对话已保存到localStorage（页面隐藏）");
          } catch (error) {
            console.error("页面可见性变化时保存临时对话失败:", error);
          }
        }
      }

      // 处理窗口失去焦点的事件（切换到其他标签页或应用）
      async function handleWindowBlur() {
        // 当窗口失去焦点时，如果有临时对话且有消息，则保存到localStorage
        if (isTemporaryConversation && currentMessages.length > 0) {
          try {
            // 只保存临时对话到localStorage，不自动保存到数据库
            localStorage.setItem(
              "tempConversation",
              JSON.stringify({
                messages: currentMessages,
                timestamp: Date.now(),
              }),
            );
            localStorage.setItem("hasTempConversation", "true");
            console.log("临时对话已保存到localStorage（窗口失去焦点）");
          } catch (error) {
            console.error("窗口失去焦点时保存临时对话失败:", error);
          }
        }
      }

      // 处理窗口获得焦点的事件
      function handleWindowFocus() {
        // 当窗口重新获得焦点时，可以刷新对话列表以获取最新数据
        loadConversations();
      }

      // 加载对话列表
      async function loadConversations() {
        try {
          const token = localStorage.getItem("authToken");
          if (!token) {
            console.warn("用户未登录，无法加载对话列表");
            return;
          }

          const response = await fetch(`${apiBaseUrl}/api/conversations`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("获取对话列表失败");
          }

          const data = await response.json();
          conversations = data.data || [];

          // 渲染对话列表
          renderConversationList();
        } catch (error) {
          console.error("加载对话列表时出错:", error);
        }
      }

      // 渲染对话列表
      function renderConversationList() {
        const container = document.getElementById("conversation-container");
        const noConversations = document.getElementById("no-conversations");

        // 清空现有内容（保留"暂无对话"提示）
        while (
          container.firstChild &&
          container.firstChild.id !== "no-conversations"
        ) {
          container.removeChild(container.firstChild);
        }

        // 如果有临时对话且有消息，先显示临时对话
        if (isTemporaryConversation && currentMessages.length > 0) {
          const tempConversationItem = createTemporaryConversationItem();
          container.insertBefore(tempConversationItem, noConversations);
        }

        if (
          conversations.length === 0 &&
          (!isTemporaryConversation || currentMessages.length === 0)
        ) {
          noConversations.style.display = "block";
          return;
        }

        noConversations.style.display = "none";

        // 添加已保存的对话项
        conversations.forEach((conversation, index) => {
          const conversationItem = createConversationItem(conversation, index);
          container.insertBefore(conversationItem, noConversations);
        });
      }

      // 创建临时对话项
      function createTemporaryConversationItem() {
        const div = document.createElement("div");
        div.className = "relative group";
        div.dataset.conversationId = "temp";

        // 获取最后一条消息作为预览
        let preview = "";
        if (currentMessages.length > 0) {
          const lastMessage = currentMessages[currentMessages.length - 1];
          preview = lastMessage.content.substring(0, 50);
          if (lastMessage.content.length > 50) {
            preview += "...";
          }
        }

        div.innerHTML = `
                <div class="p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors duration-200 bg-blue-50 border-l-4 border-primary" 
                     onclick="selectTemporaryConversation()">
                    <div class="truncate font-medium">新对话 (未保存)</div>
                    <div class="text-xs text-gray-500 truncate mt-1">${preview}</div>
                    <div class="text-xs text-gray-400 mt-1">临时对话</div>
                </div>
                <!-- 悬停菜单 -->
                <div class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                    <button class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-200" onclick="saveTemporaryConversationNow(event)">
                        <i class="fa fa-save"></i>
                    </button>
                </div>
            `;

        return div;
      }

      // 选择临时对话
      function selectTemporaryConversation() {
        currentConversationId = null;
        isTemporaryConversation = true;

        // 恢复临时对话的消息
        const tempConversation = localStorage.getItem("tempConversation");
        if (tempConversation) {
          try {
            const tempData = JSON.parse(tempConversation);
            currentMessages = tempData.messages || [];
          } catch (e) {
            console.error("解析临时对话数据失败:", e);
            currentMessages = [];
          }
        }

        renderConversationList();
        document.getElementById("conversation-title").textContent = "新对话";

        // 渲染临时对话的消息
        renderChatMessages();
      }

      // 立即保存临时对话
      async function saveTemporaryConversationNow(event) {
        event.stopPropagation();
        try {
          if (currentMessages.length === 0) {
            alert("没有消息可以保存");
            return;
          }

          const savedConversation = await saveTemporaryConversation();
          if (savedConversation) {
            // 切换到已保存的对话
            await selectConversation(savedConversation._id);
          }
        } catch (error) {
          console.error("保存临时对话时出错:", error);
          alert("保存失败，请稍后再试");
        }
      }

      // 创建对话项
      function createConversationItem(conversation, index) {
        const div = document.createElement("div");
        div.className = "relative group";
        div.dataset.conversationId = conversation._id;

        // 格式化时间
        const updatedAt = new Date(conversation.updatedAt);
        const timeString = formatDate(updatedAt);

        // 获取最后一条消息作为预览
        let preview = "";
        if (conversation.messages && conversation.messages.length > 0) {
          const lastMessage =
            conversation.messages[conversation.messages.length - 1];
          preview = lastMessage.content.substring(0, 50);
          if (lastMessage.content.length > 50) {
            preview += "...";
          }
        }

        div.innerHTML = `
                <div class="p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors duration-200 ${
                  currentConversationId === conversation._id
                    ? "bg-blue-50 border-l-4 border-primary"
                    : ""
                }" 
                     onclick="selectConversation('${conversation._id}')">
                    <div class="truncate font-medium">${
                      conversation.title
                    }</div>
                    <div class="text-xs text-gray-500 truncate mt-1">${preview}</div>
                    <div class="text-xs text-gray-400 mt-1">${timeString}</div>
                </div>
                <!-- 悬停菜单 -->
                <div class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                    <button class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-200" onclick="toggleContextMenu(event, 'menu-${index}')">
                        <i class="fa fa-ellipsis-v"></i>
                    </button>
                    <div class="hidden absolute right-0 mt-1 w-36 bg-white rounded-lg shadow-lg border border-border-color py-1 z-10" id="menu-${index}">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="renameConversation('${
                          conversation._id
                        }')">重命名</a>
                        <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50" onclick="deleteConversation('${
                          conversation._id
                        }')">删除</a>
                    </div>
                </div>
            `;

        return div;
      }

      // 格式化日期
      function formatDate(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) {
          return "刚刚";
        } else if (diffMins < 60) {
          return `${diffMins}分钟前`;
        } else if (diffHours < 24) {
          return `${diffHours}小时前`;
        } else if (diffDays < 7) {
          return `${diffDays}天前`;
        } else {
          return date.toLocaleDateString("zh-CN");
        }
      }

      // 切换上下文菜单
      function toggleContextMenu(event, menuId) {
        event.stopPropagation();

        // 隐藏所有其他菜单
        document.querySelectorAll('[id^="menu-"]').forEach((menu) => {
          if (menu.id !== menuId) {
            menu.classList.add("hidden");
          }
        });

        // 切换当前菜单
        const menu = document.getElementById(menuId);
        if (menu) {
          menu.classList.toggle("hidden");
        }
      }

      // 选择对话
      async function selectConversation(conversationId) {
        try {
          // 如果当前有临时对话且有消息，保存到数据库
          if (isTemporaryConversation && currentMessages.length > 0) {
            await saveTemporaryConversation();
          }

          // 更新当前对话ID
          currentConversationId = conversationId;
          isTemporaryConversation = false;

          // 保存当前对话ID到localStorage
          localStorage.setItem("lastViewedConversation", conversationId);

          // 更新UI
          renderConversationList();

          // 加载对话内容
          await loadChatHistory(conversationId);

          // 更新标题
          const conversation = conversations.find(
            (c) => c._id === conversationId,
          );
          if (conversation) {
            document.getElementById("conversation-title").textContent =
              conversation.title;
          }
        } catch (error) {
          console.error("选择对话时出错:", error);
        }
      }

      // 新建对话
      async function createNewConversation() {
        try {
          // 如果当前有临时对话且有消息，保存到数据库
          if (isTemporaryConversation && currentMessages.length > 0) {
            await saveTemporaryConversation();
          }

          // 重置当前对话状态
          currentConversationId = null;
          currentMessages = [];
          isTemporaryConversation = true;

          // 清除localStorage中保存的对话ID
          localStorage.removeItem("lastViewedConversation");

          // 渲染聊天区域
          renderChatMessages();

          // 更新标题
          document.getElementById("conversation-title").textContent = "新对话";

          // 更新对话列表UI
          renderConversationList();
        } catch (error) {
          console.error("创建新对话时出错:", error);
        }
      }

      // 重命名对话
      async function renameConversation(conversationId) {
        // 如果重命名的是当前对话，需要先保存临时对话到数据库
        if (
          conversationId === currentConversationId &&
          isTemporaryConversation &&
          currentMessages.length > 0
        ) {
          await saveTemporaryConversation();
        }

        const conversation = conversations.find(
          (c) => c._id === conversationId,
        );
        if (!conversation) return;

        // 创建自定义重命名对话框
        const dialog = document.createElement("div");
        dialog.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        dialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-96">
                    <h3 class="text-lg font-medium mb-4">重命名对话</h3>
                    <input type="text" id="rename-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="${conversation.title}" maxlength="50">
                    <div class="flex justify-end mt-4 space-x-2">
                        <button id="rename-cancel" class="px-4 py-2 text-gray-600 hover:text-gray-800">取消</button>
                        <button id="rename-confirm" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">确定</button>
                    </div>
                </div>
            `;

        document.body.appendChild(dialog);

        // 聚焦输入框并选中文本
        const input = document.getElementById("rename-input");
        input.focus();
        input.select();

        // 处理确认按钮点击
        const confirmBtn = document.getElementById("rename-confirm");
        const cancelBtn = document.getElementById("rename-cancel");

        const handleRename = async () => {
          const newTitle = input.value.trim();
          if (!newTitle) return;

          try {
            const token = localStorage.getItem("authToken");
            const response = await fetch(
              `${apiBaseUrl}/api/conversations/${conversationId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ title: newTitle }),
              },
            );

            if (!response.ok) {
              throw new Error("重命名对话失败");
            }

            // 更新本地数据
            conversation.title = newTitle;

            // 如果是当前对话，更新标题
            if (currentConversationId === conversationId) {
              document.getElementById("conversation-title").textContent =
                newTitle;
            }

            // 重新渲染对话列表
            renderConversationList();
          } catch (error) {
            console.error("重命名对话时出错:", error);
            alert("重命名失败，请稍后再试");
          } finally {
            document.body.removeChild(dialog);
          }
        };

        const handleCancel = () => {
          document.body.removeChild(dialog);
        };

        confirmBtn.addEventListener("click", handleRename);
        cancelBtn.addEventListener("click", handleCancel);

        // 按Enter键确认，按Esc键取消
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            handleRename();
          } else if (e.key === "Escape") {
            handleCancel();
          }
        });
      }

      // 删除对话
      async function deleteConversation(conversationId) {
        if (!confirm("确定要删除这个对话吗？此操作不可撤销。")) return;

        try {
          // 如果删除的是当前对话，需要先保存临时对话到数据库
          if (
            conversationId === currentConversationId &&
            isTemporaryConversation &&
            currentMessages.length > 0
          ) {
            await saveTemporaryConversation();
          }

          const token = localStorage.getItem("authToken");
          const response = await fetch(
            `${apiBaseUrl}/api/conversations/${conversationId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          if (!response.ok) {
            throw new Error("删除对话失败");
          }

          // 从本地数据中移除
          conversations = conversations.filter((c) => c._id !== conversationId);

          // 如果删除的是当前对话，创建新对话
          if (currentConversationId === conversationId) {
            createNewConversation();
          }

          // 重新渲染对话列表
          renderConversationList();
        } catch (error) {
          console.error("删除对话时出错:", error);
          alert("删除失败，请稍后再试");
        }
      }

      // 新建对话按钮事件
      document
        .getElementById("new-conversation-btn")
        .addEventListener("click", createNewConversation);

      // 监听存储事件，当其他页面更新localStorage时同步更新用户信息显示
      window.addEventListener("storage", function (e) {
        if (e.key === "userNickname" || e.key === "currentUser") {
          updateUserInfo();
        }
      });

      // 更新用户信息显示
      async function updateUserInfo() {
        try {
          // 首先尝试从服务器获取最新的用户信息
          const token = localStorage.getItem("authToken");
          if (token) {
            const response = await fetch(`${apiBaseUrl}/api/auth/verify`, {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (response.ok) {
              const data = await response.json();
              const displayNickname = data.user.nickname || "访客";
              const displayUsername = data.user.username || "";

              // 更新界面上的显示
              const displayNicknameElement = document.getElementById(
                "user-display-nickname",
              );
              if (displayNicknameElement) {
                displayNicknameElement.textContent = displayNickname;
              }

              const displayUsernameElement = document.getElementById(
                "user-display-username",
              );
              if (displayUsernameElement) {
                displayUsernameElement.textContent = displayUsername;
              }

              // 同时更新localStorage
              localStorage.setItem("userNickname", data.user.nickname || "");
              localStorage.setItem("currentUser", data.user.username || "");
              localStorage.setItem("userLoggedIn", "true");
              return;
            } else {
              // 如果验证失败，清除本地存储并重定向到登录页面
              localStorage.removeItem("authToken");
              localStorage.removeItem("userNickname");
              localStorage.removeItem("currentUser");
              localStorage.removeItem("userLoggedIn");
              window.location.href = "login.html";
              return;
            }
          }

          // 如果没有token，尝试从localStorage获取用户信息
          const userNickname = localStorage.getItem("userNickname");
          const currentUser = localStorage.getItem("currentUser");
          const userLoggedIn = localStorage.getItem("userLoggedIn");

          if (userLoggedIn === "true" && (userNickname || currentUser)) {
            const displayNickname = userNickname || "访客";
            const displayUsername = currentUser || "";

            const displayNicknameElement = document.getElementById(
              "user-display-nickname",
            );
            if (displayNicknameElement) {
              displayNicknameElement.textContent = displayNickname;
            }

            const displayUsernameElement = document.getElementById(
              "user-display-username",
            );
            if (displayUsernameElement) {
              displayUsernameElement.textContent = displayUsername;
            }
            return;
          }

          // 如果都没有用户信息，重定向到登录页面
          window.location.href = "login.html";
        } catch (error) {
          console.error("更新用户信息时出错:", error);
        }
      }

      // 初始化聊天界面
      async function initializeChat() {
        // 首先设置事件监听器，确保它们总是会被执行
        // 设置发送按钮事件
        const sendButton = document.getElementById("send-button");
        if (sendButton) {
          sendButton.addEventListener("click", sendMessage);
        }

        // 设置输入框回车发送事件
        const messageInput = document.getElementById("message-input");
        if (messageInput) {
          messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });
        }

        // 设置返回按钮事件
        const backButton = document.getElementById("back-button");
        if (backButton) {
          backButton.addEventListener("click", () => {
            window.location.href = "user-center.html";
          });
        }

        // 检查URL参数中是否有指定的对话ID
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get("conversation");

        // 先加载对话列表
        await loadConversations();

        if (conversationId) {
          // 如果有指定对话ID，加载该对话
          await selectConversation(conversationId);
        } else {
          // 首先检查是否有未保存的临时对话
          const hasTempConversation = localStorage.getItem(
            "hasTempConversation",
          );
          const tempConversation = localStorage.getItem("tempConversation");

          if (hasTempConversation === "true" && tempConversation) {
            try {
              const tempData = JSON.parse(tempConversation);
              // 检查临时对话是否是最近的（24小时内）
              const isRecent =
                Date.now() - tempData.timestamp < 24 * 60 * 60 * 1000;

              if (
                isRecent &&
                tempData.messages &&
                tempData.messages.length > 0
              ) {
                // 恢复临时对话
                currentMessages = tempData.messages;
                isTemporaryConversation = true;
                currentConversationId = null;

                // 清除标题显示
                document.getElementById("conversation-title").textContent =
                  "新对话";

                // 渲染消息
                renderChatMessages();
              } else {
                // 临时对话过期或无效，清除localStorage
                localStorage.removeItem("tempConversation");
                localStorage.removeItem("hasTempConversation");
                isTemporaryConversation = false;
              }
            } catch (error) {
              console.error("恢复临时对话时出错:", error);
              // 清除无效的临时对话数据
              localStorage.removeItem("tempConversation");
              localStorage.removeItem("hasTempConversation");
              isTemporaryConversation = false;
            }
          } else {
            // 确保在没有临时对话时，isTemporaryConversation为false
            isTemporaryConversation = false;
          }

          // 更新对话列表，显示临时对话（如果有的话）
          renderConversationList();

          // 检查localStorage中是否有上次查看的对话ID
          const lastViewedConversationId = localStorage.getItem(
            "lastViewedConversation",
          );

          if (isTemporaryConversation) {
            // 如果有临时对话，不加载历史对话
            console.log("当前有临时对话，不加载历史对话");
          } else {
            // 无论是否有历史对话，都显示新对话界面
            console.log("显示新对话界面");
            // 确保没有加载任何对话
            currentConversationId = null;
            currentMessages = [];
            document.getElementById("conversation-title").textContent =
              "新对话";
            renderChatMessages();
          }
        }
      }

      // 渲染聊天消息
      function renderChatMessages() {
        // 清空聊天区域
        const chatMessages = document.getElementById("chat-messages");
        if (!chatMessages) return;

        chatMessages.innerHTML = "";

        // 如果没有消息，显示欢迎消息
        if (currentMessages.length === 0) {
          chatMessages.innerHTML = `
                    <!-- 欢迎消息 -->
                    <div class="flex items-start space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex-shrink-0 flex items-center justify-center shadow-lg">
                            <i class="fa fa-smile-o text-white text-lg"></i>
                        </div>
                        <div class="message-bubble-ai p-4 max-w-[70%]">
                            <p>欢迎使用植物营养土壤肥料灌溉科普系统！</p>
                            <p class="mt-2">我是你的AI助手，专门解答关于植物营养、土壤、肥料和灌溉的各种问题。请输入你的问题，我会尽力为你提供帮助。</p>
                        </div>
                    </div>
                `;
          return;
        }

        // 显示所有消息
        currentMessages.forEach((msg) => {
          addMessageToChat(msg.role, msg.content);
        });
      }

      // 添加消息到聊天区域
      function addMessageToChat(role, content) {
        const chatMessages = document.getElementById("chat-messages");
        if (!chatMessages) return;

        const messageHtml =
          role === "user"
            ? `<div class="flex items-start justify-end space-x-4">
                    <div class="message-bubble-user p-4 max-w-[70%]">
                        <p>${escapeHtml(content)}</p>
                    </div>
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0">
                        <i class="fa fa-user text-gray-500 flex items-center justify-center h-full"></i>
                    </div>
                </div>`
            : `<div class="flex items-start space-x-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex-shrink-0 flex items-center justify-center shadow-lg">
                        <i class="fa fa-smile-o text-white text-lg"></i>
                    </div>
                    <div class="message-bubble-ai p-4 max-w-[70%]">
                        <p>${formatMessageText(content)}</p>
                    </div>
                </div>`;

        chatMessages.insertAdjacentHTML("beforeend", messageHtml);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // 加载聊天历史
      async function loadChatHistory(chatId) {
        try {
          // 获取认证token
          const token = localStorage.getItem("authToken");
          if (!token) {
            console.warn("用户未登录，无法加载对话历史");
            return;
          }

          // 从API获取特定对话
          const response = await fetch(
            `${apiBaseUrl}/api/conversations/${chatId}`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          if (!response.ok) {
            throw new Error("获取对话历史失败");
          }

          const data = await response.json();
          const conversation = data.data; // 修正这里，应该是data.data而不是data.conversation

          if (conversation) {
            // 更新标题
            document.getElementById("conversation-title").textContent =
              conversation.title;

            // 更新当前消息数组
            currentMessages = conversation.messages || [];

            // 清空聊天区域
            const chatMessages = document.getElementById("chat-messages");
            chatMessages.innerHTML = "";

            // 显示所有消息
            conversation.messages.forEach((msg) => {
              addMessageToChat(msg.role, msg.content);
            });
          }
        } catch (error) {
          console.error("加载对话历史时出错:", error);
          addMessageToChat("assistant", "加载对话历史时出错，请稍后再试。");
        }
      }

      // 发送消息函数
      async function sendMessage() {
        const messageInput = document.getElementById("message-input");
        const chatMessages = document.getElementById("chat-messages");

        if (!messageInput || !chatMessages) return;

        const message = messageInput.value.trim();
        if (message === "") return;

        // 添加用户消息到界面
        const userMessageHtml = `
                <div class="flex items-start justify-end space-x-4">
                    <div class="message-bubble-user p-4 max-w-[70%]">
                        <p>${escapeHtml(message)}</p>
                    </div>
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0">
                        <i class="fa fa-user text-gray-500 flex items-center justify-center h-full"></i>
                    </div>
                </div>
            `;
        chatMessages.insertAdjacentHTML("beforeend", userMessageHtml);

        // 清空输入框并重置高度
        messageInput.value = "";
        messageInput.style.height = "auto";

        // 滚动到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // 将用户消息添加到临时消息数组
        currentMessages.push({ role: "user", content: message });

        // 如果没有当前对话ID，标记为临时对话
        if (!currentConversationId) {
          isTemporaryConversation = true;
        }

        // 发送消息到AI服务
        await sendToAI(message);
      }

      // 创建新对话并发送消息
      async function createNewConversationWithMessage(message) {
        try {
          const token = localStorage.getItem("authToken");
          if (!token) {
            throw new Error("用户未登录");
          }

          // 创建新对话
          const createResponse = await fetch(
            `${apiBaseUrl}/api/conversations`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                title:
                  message.substring(0, 30) + (message.length > 30 ? "..." : ""),
                messages: [{ role: "user", content: message }],
              }),
            },
          );

          if (!createResponse.ok) {
            throw new Error("创建对话失败");
          }

          const createData = await createResponse.json();
          currentConversationId = createData.data._id;

          // 保存当前对话ID到localStorage
          localStorage.setItem("lastViewedConversation", currentConversationId);

          // 更新标题
          document.getElementById("conversation-title").textContent =
            createData.data.title;

          // 重新加载对话列表
          await loadConversations();

          // 发送消息到AI服务
          await sendToAI(message);
        } catch (error) {
          console.error("创建新对话时出错:", error);
          const chatMessages = document.getElementById("chat-messages");
          const errorMessageHtml = `
                    <div class="flex items-start space-x-4">
                        <div class="w-8 h-8 bg-primary rounded-full flex-shrink-0">
                            <i class="fa fa-robot text-white flex items-center justify-center h-full"></i>
                        </div>
                        <div class="message-bubble-ai p-4 max-w-[70%]">
                            <p>创建对话失败，请稍后再试。</p>
                            <p class="text-xs text-gray-500 mt-1">错误信息: ${escapeHtml(
                              error.message,
                            )}</p>
                        </div>
                    </div>
                `;
          chatMessages.insertAdjacentHTML("beforeend", errorMessageHtml);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }

      // 发送消息到AI服务
      async function sendToAI(message) {
        const chatMessages = document.getElementById("chat-messages");

        // 显示加载状态
        const loadingElement = addLoadingIndicator();

        try {
          // 先检查服务状态
          let healthResponse;
          try {
            healthResponse = await fetch("http://localhost:8000/health");
            const healthData = await healthResponse.json();

            if (!healthData.model_loaded) {
              throw new Error("模型未加载完成，请稍后再试");
            }
          } catch (healthError) {
            throw new Error("AI助手服务暂时不可用，请稍后再试");
          }

          // 调用RAG API
          const response = await fetch("http://localhost:8000/api/query", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              query: message,
              top_k_retrieve: 5,
              top_k_rerank: 3,
              api_key: "default_key",
            }),
          });

          if (!response.ok) {
            if (response.status === 503) {
              throw new Error("模型未加载完成，请稍后再试");
            }
            throw new Error(`API请求失败: ${response.status}`);
          }

          const data = await response.json();

          // 移除加载状态
          loadingElement.remove();

          // 添加AI回复
          const aiMessageHtml = `
                    <div class="flex items-start space-x-4">
                        <div class="w-8 h-8 bg-primary rounded-full flex-shrink-0">
                            <i class="fa fa-robot text-white flex items-center justify-center h-full"></i>
                        </div>
                        <div class="message-bubble-ai p-4 max-w-[70%]">
                            <p>${formatMessageText(data.answer)}</p>
                            
                            <!-- 显示处理时间 -->
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fa fa-clock-o"></i> 处理时间: ${data.processing_time.toFixed(
                                  2,
                                )}秒
                            </p>
                        </div>
                    </div>
                `;

          chatMessages.insertAdjacentHTML("beforeend", aiMessageHtml);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          // 将AI回复添加到临时消息数组
          currentMessages.push({ role: "assistant", content: data.answer });

          // 如果是已保存的对话，更新对话列表（因为updatedAt会变化）
          if (currentConversationId && !isTemporaryConversation) {
            // 保存新消息到数据库
            await saveConversationToDB(message, data.answer);
            await loadConversations();
          } else if (isTemporaryConversation) {
            // 如果是临时对话，保存到localStorage
            localStorage.setItem(
              "tempConversation",
              JSON.stringify({
                messages: currentMessages,
                timestamp: Date.now(),
              }),
            );
            localStorage.setItem("hasTempConversation", "true");
          }
        } catch (error) {
          // 错误处理
          console.error("Error:", error);
          loadingElement.remove();

          const errorMessageHtml = `
                    <div class="flex items-start space-x-4">
                        <div class="w-8 h-8 bg-primary rounded-full flex-shrink-0">
                            <i class="fa fa-robot text-white flex items-center justify-center h-full"></i>
                        </div>
                        <div class="message-bubble-ai p-4 max-w-[70%]">
                            <p>抱歉，无法获取回答。请稍后再试或检查后端服务是否正常运行。</p>
                            <p class="text-xs text-gray-500 mt-1">错误信息: ${escapeHtml(
                              error.message,
                            )}</p>
                        </div>
                    </div>
                `;

          chatMessages.insertAdjacentHTML("beforeend", errorMessageHtml);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }

      // 保存临时对话到数据库
      async function saveTemporaryConversation() {
        try {
          // 如果没有消息，不需要保存
          if (currentMessages.length === 0) {
            return;
          }

          const token = localStorage.getItem("authToken");
          if (!token) {
            console.warn("用户未登录，无法保存对话");
            return;
          }

          // 生成对话标题（使用第一条用户消息的前30个字符）
          const title =
            currentMessages
              .find((msg) => msg.role === "user")
              ?.content.substring(0, 30) + "..." || "新对话";

          // 创建新对话
          const response = await fetch(`${apiBaseUrl}/api/conversations`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              title,
              messages: currentMessages,
            }),
          });

          if (!response.ok) {
            throw new Error("保存对话失败");
          }

          const data = await response.json();
          currentConversationId = data.data._id;

          // 重要：更新临时对话状态标志
          isTemporaryConversation = false;

          // 清除localStorage中的临时对话数据
          localStorage.removeItem("tempConversation");
          localStorage.removeItem("hasTempConversation");

          // 保存当前对话ID到localStorage
          localStorage.setItem("lastViewedConversation", currentConversationId);

          console.log("临时对话保存成功:", data);

          // 重新加载对话列表
          await loadConversations();

          return data.data;
        } catch (error) {
          console.error("保存临时对话时出错:", error);
          throw error;
        }
      }

      // 保存对话到数据库
      async function saveConversationToDB(userMessage, aiResponse) {
        try {
          // 如果没有当前对话ID，说明是新对话，需要创建
          if (!currentConversationId) {
            console.warn("没有当前对话ID，无法保存消息");
            return;
          }

          // 获取认证token
          const token = localStorage.getItem("authToken");
          if (!token) {
            console.warn("用户未登录，无法保存对话");
            return;
          }

          // 向现有对话添加消息
          const response = await fetch(
            `${apiBaseUrl}/api/conversations/${currentConversationId}/messages`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                messages: [
                  { role: "user", content: userMessage },
                  { role: "assistant", content: aiResponse },
                ],
              }),
            },
          );

          if (!response.ok) {
            throw new Error("保存对话失败");
          }

          const data = await response.json();
          console.log("对话保存成功:", data);
        } catch (error) {
          console.error("保存对话时出错:", error);
        }
      }

      // 转义HTML字符以防止XSS攻击
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // 用户信息展开/收起功能
      function toggleUserInfo() {
        const toggleButton = document.getElementById("user-info-toggle");
        const detailsElement = document.getElementById("user-info-details");
        const iconElement = toggleButton.querySelector("i");

        if (detailsElement && iconElement) {
          if (detailsElement.classList.contains("hidden")) {
            // 展开
            detailsElement.classList.remove("hidden");
            iconElement.classList.remove("fa-angle-down");
            iconElement.classList.add("fa-angle-up");
          } else {
            // 收起
            detailsElement.classList.add("hidden");
            iconElement.classList.remove("fa-angle-up");
            iconElement.classList.add("fa-angle-down");
          }
        }
      }

      // 检查服务状态
      function checkServiceStatus() {
        const statusElement = document.getElementById("service-status");
        if (!statusElement) return;

        statusElement.classList.remove(
          "hidden",
          "bg-green-50",
          "text-green-800",
          "border-green-200",
          "bg-amber-50",
          "text-amber-800",
          "border-amber-200",
          "bg-red-50",
          "text-red-800",
          "border-red-200",
        );

        fetch("http://localhost:8000/health")
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "healthy") {
              if (data.model_loaded) {
                // 服务正常且模型已加载
                statusElement.innerHTML =
                  '<i class="fa fa-check-circle mr-2"></i><span>AI助手服务正常运行</span>';
                statusElement.classList.add(
                  "bg-green-50",
                  "text-green-800",
                  "border-green-200",
                );
              } else {
                // 服务正常但模型未加载
                statusElement.innerHTML =
                  '<i class="fa fa-exclamation-circle mr-2"></i><span>AI助手服务正在初始化中，暂时无法回答问题</span>';
                statusElement.classList.add(
                  "bg-amber-50",
                  "text-amber-800",
                  "border-amber-200",
                );
              }
            } else {
              // 服务异常
              statusElement.innerHTML =
                '<i class="fa fa-times-circle mr-2"></i><span>AI助手服务不可用，请检查后端服务</span>';
              statusElement.classList.add(
                "bg-red-50",
                "text-red-800",
                "border-red-200",
              );
            }
            statusElement.classList.remove("hidden");
          })
          .catch((error) => {
            // 无法连接到服务
            statusElement.innerHTML =
              '<i class="fa fa-times-circle mr-2"></i><span>无法连接到AI助手服务</span>';
            statusElement.classList.add(
              "bg-red-50",
              "text-red-800",
              "border-red-200",
            );
            statusElement.classList.remove("hidden");
          });
      }

      // 添加加载指示器
      function addLoadingIndicator() {
        const chatMessages = document.getElementById("chat-messages");
        const loadingHtml = `
                <div class="flex items-start space-x-4 loading-indicator">
                    <div class="w-8 h-8 bg-primary rounded-full flex-shrink-0">
                        <i class="fa fa-robot text-white flex items-center justify-center h-full"></i>
                    </div>
                    <div class="message-bubble-ai p-4 max-w-[70%]">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 200ms;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 400ms;"></div>
                        </div>
                    </div>
                </div>
            `;
        chatMessages.insertAdjacentHTML("beforeend", loadingHtml);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return document.querySelector(".loading-indicator:last-child");
      }

      // 格式化消息文本，将换行符转换为HTML换行
      function formatMessageText(text) {
        return escapeHtml(text).replace(/\n/g, "<br>");
      }

      // 退出登录按钮
      const logoutButton = document.getElementById("logout-button");
      if (logoutButton) {
        logoutButton.addEventListener("click", async function () {
          if (confirm("确定要退出登录吗？")) {
            try {
              // 如果有临时对话，先保存到数据库
              if (isTemporaryConversation && currentMessages.length > 0) {
                try {
                  await saveTemporaryConversation();
                  console.log("退出登录前已保存临时对话");
                } catch (error) {
                  console.error("保存临时对话失败:", error);
                  // 即使保存失败也继续退出流程
                }
              }

              // 清除登录状态
              localStorage.removeItem("userLoggedIn");
              localStorage.removeItem("currentUser");
              localStorage.removeItem("userNickname");
              localStorage.removeItem("authToken");

              // 清除临时对话记录（已保存到数据库）
              localStorage.removeItem("tempConversation");
              localStorage.removeItem("hasTempConversation");
              localStorage.removeItem("lastViewedConversation");

              // 更新用户信息显示
              updateUserInfo();
              // 跳转到登录页面
              window.location.href = "login.html";
            } catch (error) {
              console.error("退出登录时出错:", error);
              // 即使出错也继续退出流程
              window.location.href = "login.html";
            }
          }
        });
      }
    </script>
  </body>
</html>
